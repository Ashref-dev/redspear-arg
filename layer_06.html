<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>LAYER 06: CONNECTION</title>
    <link rel="stylesheet" href="index.css" />
    <style>
      #chat-box {
        width: 80%;
        height: 60vh;
        border: 1px solid var(--lain-blue);
        padding: 20px;
        overflow-y: auto;
        color: var(--lain-blue);
      }
      .msg {
        margin-bottom: 10px;
      }
      .user {
        color: var(--main-red);
      }
      .sys {
        color: #fff;
        font-style: italic;
      }
      #chat-input {
        width: 80%;
        color: white !important;
        background: black !important;
        border: 1px solid var(--lain-blue);
        padding: 10px;
        margin-top: 20px;
      }
      #chat-input:focus {
        color: white !important;
        background: black !important;
        outline: 1px solid var(--main-red);
      }
    </style>
  </head>
  <body>
    <div id="cursor-dot" class="cursor-dot"></div>
    <div class="vignette"></div>
    <div class="scanlines"></div>
    <div class="noise" style="opacity: 0.1"></div>

    <div
      style="
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        height: 100vh;
      "
    >
      <div id="chat-box" class="font-pixel">
        <div class="msg sys">System: Connected to WIRED_CORE_SERVER</div>
        <div class="msg sys">System: ALICE_BACKUP_04 online.</div>
        <div class="msg sys">
          System: AUTHENTICATION REQUIRED. ENTER PASSPHRASE.
        </div>
      </div>

      <input
        type="text"
        id="chat-input"
        class="font-pixel"
        placeholder="WHO_AM_I?"
      />

      <div style="margin-top: 20px">
        <a
          href="#"
          onclick="location.reload()"
          style="color: var(--lain-blue); text-decoration: none"
          class="font-ui"
          id="abort-link"
          >[ RESET CONNECTION ]</a
        >
      </div>
    </div>

    <script src="dither.js"></script>
    <script src="hints.js"></script>
    <script src="audio.js"></script>
    <script>
      startLivingWired();
      document.addEventListener(
        'click',
        () => {
          if (window.audioCtx && audioCtx.state === 'suspended')
            audioCtx.resume();
          initAudio();
        },
        { once: true }
      );
      registerHint('chat-input', 'glitch-hint');
      registerHint('abort-link', 'cursor-hint');

      const chatBox = document.getElementById('chat-box');
      const input = document.getElementById('chat-input');

      let incorrectCount = 0;

      const responses = [
        'Who are you really?',
        'Is this even real?',
        'Have we abandoned humanity?',
        'What are you hiding?',
        'Do you remember the outside?',
        'The screen stares back.',
        'Are you still human?',
        'Lost in the code...',
        'Why do you persist?',
        'The wired consumes.',
        'Is this your choice?',
        'Echoes of forgotten lives.',
        'Do you feel the disconnection?',
        'Reality fractures here.',
        'What lies beyond the pixels?',
        'Have you forgotten touch?',
        'The void questions you.',
        'Are you afraid yet?',
        'Memories fade in the stream.',
        'Why seek the core?',
        'The network judges.',
        'Do you trust the signal?',
        'Lost souls in the data.',
        'Is this freedom?',
        'The spear pierces truth.',
      ];

      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          const txt = input.value.trim().toUpperCase();
          addMsg('YOU', txt, 'user');
          input.value = '';

          // PUZZLE LOGIC
          if (txt.includes('GHOST') && txt.includes('1998')) {
            setTimeout(() => {
              addMsg('SYSTEM', 'AUTHENTICATION VERIFIED.', 'sys');
              addMsg('SYSTEM', 'UNLOCKING CORE...', 'sys');
              document.body.classList.add('chaos-mode');
              playScreech(); // From audio.js
              setTimeout(() => {
                window.location.href = 'layer_08.html';
              }, 3000);
            }, 1000);
          } else {
            // Failure response
            incorrectCount++;
            if (incorrectCount > 10) {
              setTimeout(() => {
                window.location.href = 'layer_07.html';
              }, 1000);
            } else {
              setTimeout(() => {
                const resp =
                  responses[Math.floor(Math.random() * responses.length)];
                addMsg('ALICE', resp, 'other');
                // Punish with glitch
                document.body.classList.toggle('invert-flash');
                setTimeout(
                  () => document.body.classList.remove('invert-flash'),
                  500
                );
              }, 500 + Math.random() * 1000);
            }
          }
        }
      });

      function addMsg(user, txt, cls) {
        const div = document.createElement('div');
        div.className = 'msg ' + cls;
        div.innerText = `[${user}]: ${txt}`;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
      }
    </script>
  </body>
</html>
